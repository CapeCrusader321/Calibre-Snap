name: calibre
base: core22
adopt-info: calibre
grade: stable
summary: Powerful and Advanced E-Book Reader.
description: |
  Powerful and Advanced E-Book Reader and Editor, written in python and qt.
confinement: strict
compression: lzo
architectures:
  - build-on: amd64
    build-for: amd64
layout:
  /usr/lib/$CRAFT_ARCH_TRIPLET/espeak-ng-data:
    symlink: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/espeak-ng-data

slots:
  calibre:
    interface: dbus
    bus: session
    name: com.calibre_ebook.calibre
    
apps:
  calibre:
    command: bin/calibre
    extensions:
      - kde-neon
    plugs:
      - home
      - audio-playback
      - network
      - bluez
      - network-status
      - optical-drive
      - removable-media
    common-id: com.calibre_ebook.calibre 
    desktop: share/applications/com.calibre_ebook.calibre.desktop
  
  ebook-editor:
    command: bin/ebook-edit
    plugs:
      - home
      - removable-media
      - network
  ebook-viewer:
    command: bin/ebook-viewer
    plugs:
      - home
      - removable-media
      - optical-drive
      - network
      - audio-playback
   
  lrf-viewer:
    command: bin/lrfviewer
    plugs: 
      - home
      - network
      - removable-media
      
parts:
  calibre:
    source: https://github.com/kovidgoyal/calibre.git
    parse-info: [/share/metainfo/com.calibre_ebook.calibre.metainfo.xml]
    plugin: dump
    build-packages:  
      - build-essential
      - curl
    build-environment:
      - XDG_UTILS_INSTALL_MODE=system
    override-pull: |
      craftctl default
      craftctl set version=$(git describe --tags --abbrev=0 | cut -c 2-)
      VER="$(git describe --tags --abbrev=0 | cut -c 2-)"
      curl -LO https://github.com/kovidgoyal/calibre/releases/download/v${VER}/calibre-${VER}-x86_64.txz
    override-build : |
      craftctl default
      mkdir -p $CRAFT_PART_INSTALL/lib/calibre
      mkdir -p "${CRAFT_PART_INSTALL}/bin" "${CRAFT_PART_INSTALL}"/share/{applications,desktop-directories,icons/hicolor,mime/packages}
      tar -xvf calibre*.txz -C "${CRAFT_PART_INSTALL}/lib/calibre"
      rm -f calibre*.txz
      $CRAFT_PART_INSTALL/lib/calibre/calibre_postinstall --root=$CRAFT_PART_INSTALL
      # post-install for ebook-edit
      mv $CRAFT_PART_INSTALL/share/applications/{calibre-ebook-edit,com.calibre_ebook.calibre.ebook-edit}.desktop
      for p in 16 32 48 64 128 256; do mv $CRAFT_PART_INSTALL/share/icons/hicolor/${p}x${p}/apps/{calibre-ebook-edit,com.calibre_ebook.calibre.ebook-edit}.png;
      done
      desktop-file-edit --set-key Icon --set-value com.calibre_ebook.calibre.ebook-edit $CRAFT_PART_INSTALL/share/applications/com.calibre_ebook.calibre.ebook-edit.desktop

      # post-install for ebook-viewer
      # NOTE: Upstream desktop and icon basenames do not match
      mv $CRAFT_PART_INSTALL/share/applications/{calibre-ebook-viewer,com.calibre_ebook.calibre.ebook-viewer}.desktop
      for p in 16 32 48 64 128 256; do mv $CRAFT_PART_INSTALL/share/icons/hicolor/${p}x${p}/apps/{calibre-viewer,com.calibre_ebook.calibre.ebook-viewer}.png;
      done
      desktop-file-edit --set-key Icon --set-value com.calibre_ebook.calibre.ebook-viewer $CRAFT_PART_INSTALL/share/applications/com.calibre_ebook.calibre.ebook-viewer.desktop

      # post-install for lrfviewer
      # NOTE: Both lrfviewer and ebook-viewer share the same icon
      mv $CRAFT_PART_INSTALL/share/applications/{calibre-lrfviewer,com.calibre_ebook.calibre.lrfviewer}.desktop
      desktop-file-edit --set-key Icon --set-value com.calibre_ebook.calibre.ebook-viewer $CRAFT_PART_INSTALL/share/applications/com.calibre_ebook.calibre.lrfviewer.desktop

      # post-install for calibre
      mv $CRAFT_PART_INSTALL/share/applications/{calibre-gui,com.calibre_ebook.calibre}.desktop
      for p in 16 32 48 64 128 256; do mv $CRAFT_PART_INSTALL/share/icons/hicolor/${p}x${p}/apps/{calibre-gui,com.calibre_ebook.calibre}.png;
      done
      desktop-file-edit --set-key Icon --set-value com.calibre_ebook.calibre $CRAFT_PART_INSTALL/share/applications/com.calibre_ebook.calibre.desktop

      # post-install for metainfo
      mv $CRAFT_PART_INSTALL/share/metainfo/{calibre-gui,com.calibre_ebook.calibre}.metainfo.xml
      appstream-util modify $CRAFT_PART_INSTALL/share/metainfo/com.calibre_ebook.calibre.metainfo.xml
      id com.calibre_ebook.calibre
      appstream-util modify $CRAFT_PART_INSTALL/share/metainfo/com.calibre_ebook.calibre.metainfo.xml
      launchable com.calibre_ebook.calibre.desktop
      appstream-util add-provide $CRAFT_PART_INSTALL/share/metainfo/com.calibre_ebook.calibre.metainfo.xml
      id calibre-gui.desktop

      # post-install for MIME types
      mv $CRAFT_PART_INSTALL/share/mime/packages/{calibre-mimetypes,com.calibre_ebook.calibre}.xml
    
  tts:
    plugin: nil
    stage-packages:
      - espeak-ng
      - speech-dispatcher-espeak-ng
      - libaudio2
      - libsndio7.0
